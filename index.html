<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Stock Tracker</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <!-- jQuery library -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <!-- Popper JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <!-- Latest compiled JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <main class="container-sm p-5">
        <h1>Stock Tracker</h1>
        <!-- Add show more button to display  -->
        <!-- <p>This application allows users to input a company's stock symbol and it's index which will scrape Google's finance quote webpage (https://www.google.com/finance/ + company symbol : market index) to collect the latest price and new's. The user can save stocks they wish to track into a database to be viewed anytime they access the website. They will also have an option to have an email sent to them when a stock price changes or for the latest news item.</p> -->
        <p>Type a company stock symbol into the search bar and select it's correct stock exchange. Next, click the search button
            and your stock will be displayed in a list below. The server will store the stock you search in an array</p>
        <label class="form-label mt-4" for="search">Search Stock</label>
        <br></br>
        <div class="dropdown">
            <input type="text" id="search-bar" class="form-text p-1" name="search">
            <span class="colon-symbol">:</span>
            <button class="btn btn-primary dropdown-toggle" type="button" id="dropdownMenu" data-toggle="dropdown"
                aria-haspopup="true" aria-expanded="false">
                Stock Exchange
            </button>
            <div class="dropdown-menu" id="drop-menu" aria-labelledby="dropdownMenu">
                <h6 class="dropdown-header">Stock Exchange</h6>
                <button class="dropdown-item" type="button">NASDAQ</button>
                <button class="dropdown-item" type="button">NYSE</button>
                <button class="dropdown-item" type="button">NSE</button>
                <button class="dropdown-item" type="button">FSX</button>
                <button class="dropdown-item" type="button">HKEX</button>
                <button class="dropdown-item" type="button">JPX</button>
                <button class="dropdown-item" type="button">LSE</button>
                <button class="dropdown-item" type="button">SSE</button>
                <button class="dropdown-item" type="button">SZSE</button>
                <button class="dropdown-item" type="button">TSE</button>
                <button class="dropdown-item" type="button">TSX</button>
            </div>
        </div>
        </div>
        </div>

        <br></br>
        <button class="btn btn-success mb-5" id="btn-server">Search</button>
        <div class="container-fluid row stock-list-container">
            <ul class="stock-list list-group flex-container"></ul>
        </div>
    </main>

    <script>
        var socket = io()

        var stockExchange;

        let listContainer = $(".stock-list");

        socket.on("connect", () => console.log("Socket Connected"))

        let checkList = ([...stockList]) => {
            let array = [];

            stockList.map(x => {
                let found = array.includes(x.company);
                if (found) {
                    $(`.card .card-header:contains('${x.company}')`).parent('li').append(`<p class="card-text card-stock"> ${x.stock} </p> <p class="card-text card-price"> ${x.price} </p>`);
                } else {
                    array.push(x.company);
                    listContainer.append(`<li class="card card-body list-group-item row"> <p class="card-header"> ${x.company} </p> <p class="card-text card-stock"> ${x.stock} </p> <p class="card-text card-price"> ${x.price} </p> </li>`);
                }
            });

        }

        let addStock = (data) => {
            let companyList = [...$(".stock-list .card-header")];
            let stockList = [...$(".stock-list .card-stock")];
            let t = false;
            if (listContainer[0].childNodes.length < 1) {
                listContainer.append(`<li class="card card-body list-group-item row"> <p class="card-header"> ${data.company} </p> <p class="card-text card-stock"> ${data.stock} </p> <p class="card-text card-price"> ${data.price} </p> </li>`);

            } else {
                for (let i = 0; i < companyList.length; i++) {
                    console.log("For Loop index: ", i);
                    let n = companyList[i].innerText;
                    if (n === data.company) {
                        console.log(n, "match", companyList[i].innerText, "match", data.company);
                        companyList[i].parentElement.innerHTML += `<p class="card-text card-stock"> ${data.stock} </p> <p class="card-text card-price"> ${data.price} </p>`;
                        t = true;
                    } else {
                        console.log("no name exists");
                    }
                };
                if (!t) {
                    listContainer.append(`<li class="card card-body list-group-item row"> <p class="card-header"> ${data.company} </p> <p class="card-text card-stock"> ${data.stock} </p> <p class="card-text card-price"> ${data.price} </p> </li>`);
                }
            }
        }

        let refresh = (update) => {
            let listStocks = [...$(".card-stock")];
            let listPrices = [...$(".card-price")];
            let updatePrice = [];
            let updateStock = [];

            for (let i = 0; i < update.length; i++) {
                updateStock.push(update[i].stock);
                updatePrice.push(update[i].price);

            };

            listStocks.map((x, i) => {

                if (x.innerText === updateStock[i]) {
                    listPrices.map((y, i) => {
                        let currentPrice = y.innerText.substring(1).replace(',', '');
                        let newPrice = updatePrice[i].substring(1).replace(',', '');
                        let change = Number(newPrice - currentPrice);

                        if (currentPrice < newPrice) {
                            console.log("green", change);
                            // listPrices[i].innerText = updatePrice[i], change;
                            listPrices[i].style.color = "green";

                        } else if (currentPrice = newPrice) {
                            // listPrices[i].innerText = updatePrice[i], change;

                            console.log(listPrices[i].innerText);

                        } else if (currentPrice > newPrice) {
                            // listPrices[i].innerText = updatePrice[i], change;
                            console.log("red", change);
                            // listPrices[i].innerText +=  ` ${change}`;
                            listPrices[i].style.color = "red";
                            // console.log(listPrices[i].innerText);
                        }
                        y.innerText = updatePrice[i];
                    });
                }
            });
        }

        $('.dropdown-item').click((e) => {
            stockExchange = e.target.textContent;
            $('#dropdownMenu')[0].innerHTML = e.target.textContent;
        })

        $('#btn-server').click(() => {
            if (!stockExchange) {
                alert("Please select a stock exchange")
            } else {
                let search = { name: $('#search-bar')[0].value.toUpperCase().replace(/\s/g, ''), stock: stockExchange };
                console.log("Search Clicked");
                searchStock(search);
            }
        })

        let searchError = (errStock, errStockExchange) => {
            alert(`The stock symbol ${errStock} does not belong to ${errStockExchange} or it doesn't exist.`);
        }

        let searchStock = (search) => $.post("http://localhost:3000", search)

        socket.on('search', addStock)

        socket.on('sendList', checkList)

        socket.on('refresh', refresh)

        socket.on('error', searchError);

    </script>
</body>

</html>